from google.colab import drive
drive.mount('/content/drive')

!pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
!pip install transformers
!pip install pillow

from transformers import CLIPProcessor, CLIPModel
import torch

# CLIP ëª¨ë¸ ë¡œë“œ
model = CLIPModel.from_pretrained("openai/clip-vit-base-patch32")
processor = CLIPProcessor.from_pretrained("openai/clip-vit-base-patch32")

print("âœ… CLIP ëª¨ë¸ ë¡œë“œ ì™„ë£Œ!")

# 1ì°¨ í•„í„°ë§

import os

# êµ¬ê¸€ ë“œë¼ì´ë¸Œ ë‚´ ì´ë¯¸ì§€ í´ë” ê²½ë¡œ
image_folder = "/content/drive/MyDrive/á„‰á…µá†¨á„Œá…¢á„…á…­/ëŒ€íŒŒ"
filtered_folder = "/content/drive/MyDrive/á„‰á…µá†¨á„Œá…¢á„…á…­ á„‘á…µá†¯á„á…¥á„…á…µá†¼/f_ëŒ€íŒŒ"  # í•„í„°ë§ëœ ì´ë¯¸ì§€ ì €ì¥ í´ë”

# í•„í„°ë§ëœ ì´ë¯¸ì§€ ì €ì¥í•  í´ë” ë§Œë“¤ê¸°
os.makedirs(filtered_folder, exist_ok=True)

print(f"ì´ë¯¸ì§€ í´ë”: {image_folder}")
print(f"í•„í„°ë§ëœ ì´ë¯¸ì§€ ì €ì¥ í´ë”: {filtered_folder}")

from PIL import Image

# CLIP ëª¨ë¸ì´ ë¶„ë¥˜í•  í…ìŠ¤íŠ¸ ë¼ë²¨
text_inputs = ["This is a vegetable from the kitchen", "This is a cooked dish", "This is an unrelated image"]

# ì´ë¯¸ì§€ í´ë”ì—ì„œ í•˜ë‚˜ì”© ë¶„ì„í•˜ì—¬ í•„í„°ë§
for image_name in os.listdir(image_folder):
    image_path = os.path.join(image_folder, image_name)

    try:
        image = Image.open(image_path)  # ì´ë¯¸ì§€ ë¶ˆëŸ¬ì˜¤ê¸°

        # CLIP ëª¨ë¸ ì…ë ¥ ì¤€ë¹„
        inputs = processor(text=text_inputs, images=image, return_tensors="pt", padding=True)
        outputs = model(**inputs)

        # ì˜ˆì¸¡ í™•ë¥  ê³„ì‚°
        probs = torch.softmax(outputs.logits_per_image, dim=1).tolist()[0]

        # "Raw ingredient(ìƒí’ˆ)"ì¼ í™•ë¥ ì´ ê°€ì¥ ë†’ë‹¤ë©´ ì €ì¥
        if probs[0] > max(probs[1], probs[2]):
            image.save(os.path.join(filtered_folder, image_name))
            print(f"âœ… ìƒí’ˆ ì´ë¯¸ì§€ë¡œ ë¶„ë¥˜ë¨: {image_name}")
        else:
            os.remove(image_path)
            print(f"âŒ ì œê±°ë¨: {image_name} (ì¡°ë¦¬ëœ ìŒì‹ ë˜ëŠ” ë¬´ê´€í•œ ì´ë¯¸ì§€)")

    except Exception as e:
        os.remove(image_path)
        print(f"âš ï¸ ì˜¤ë¥˜ ë°œìƒ: {image_name} - {str(e)}")

print("ğŸ¯ í•„í„°ë§ ì™„ë£Œ: ìƒí’ˆ ì´ë¯¸ì§€ë§Œ ë‚¨ê²¼ìŠµë‹ˆë‹¤!")


# 2ì°¨ í•„í„°ë§

import os

# ğŸ“‚ í´ë”ë³„ text_inputs ì„¤ì • (ì§‘ì—ì„œ ì°ì€ ì‹ì¬ë£Œì™€ ìœ ì‚¬í•˜ë„ë¡ ìˆ˜ì •)
folder_text_inputs = {
    "f_onion": ["This is a fresh vegetable from the kitchen", "This is a cooked vegetable dish", "This is an unrelated image"],
    "f_carrot": ["This is a fresh vegetable from the kitchen", "This is a cooked vegetable dish", "This is an unrelated image"],
    "f_ì½©ë‚˜ë¬¼": ["This is a fresh vegetable from the kitchen", "This is a cooked vegetable dish", "This is an unrelated image"],
    "f_ì–‘ë°°ì¶”": ["This is a fresh vegetable from the kitchen", "This is a cooked vegetable dish", "This is an unrelated image"],
    "f_ëŒ€íŒŒ": ["This is a fresh vegetable in the refrigerator of my house", "This is a cooked vegetable dish", "This is an unrelated image"],
    "f_ë²„ì„¯": ["This is a fresh vegetable, a cooking ingredient used in the kitchen", "This is a cooked vegetable dish", "This is an unrelated image", "This is a wild mushroom"],
    "f_ê³ ì¶”": ["This is a fresh vegetable from the kitchen", "This is a cooked vegetable dish", "This is an unrelated image"],

    "f_ì†Œê³ ê¸°": ["This is raw meat from the refrigerator", "This is a cooked meat dish", "This is an unrelated image"],
    "f_ë¼ì§€ê³ ê¸°": ["This is raw meat from the refrigerator", "This is a cooked meat dish", "This is an unrelated image"],
    "f_ë‹­ê³ ê¸°": ["This is raw meat from the refrigerator", "This is a cooked meat dish", "This is an unrelated image"],
    "f_ì˜¤ë¦¬ê³ ê¸°": ["This is raw meat from the refrigerator", "This is a cooked meat dish", "This is an unrelated image"],

    "f_ê³ ë“±ì–´": ["This is raw fish from the kitchen", "This is a cooked fish dish", "This is an unrelated image"],
    "f_ê°ˆì¹˜": ["This is raw fish from the kitchen", "This is a cooked fish dish", "This is an unrelated image"],

    "f_ìš°ìœ ": ["This is a dairy product with an expiration date", "This is a cooked dairy dish", "This is an unrelated image"],
    "f_ë²„í„°": ["This is a dairy product with an expiration date", "This is a cooked dairy dish", "This is an unrelated image"],
    "f_ì¹˜ì¦ˆ": ["This is a dairy product with an expiration date", "This is a cooked dairy dish", "This is an unrelated image"],

    "f_ë‹¬ê±€": ["This is a raw egg from the refrigerator", "This is a cooked egg dish", "This is an unrelated image"]
}

# ğŸ“‚ ì´ë¯¸ì§€ í´ë” ê²½ë¡œ (â˜… ë³¸ì¸ ê²½ë¡œì— ë§ê²Œ ìˆ˜ì • â˜…)
base_folder = "/content/drive/MyDrive/á„‰á…µá†¨á„Œá…¢á„…á…­ á„‘á…µá†¯á„á…¥á„…á…µá†¼"
filtered_base_folder = "/content/drive/MyDrive/á„‰á…µá†¨á„Œá…¢á„…á…­ 2á„á…¡ á„‘á…µá†¯á„á…¥á„…á…µá†¼"
os.makedirs(filtered_base_folder, exist_ok=True)

# ğŸ”„ ì‚¬ìš©ìê°€ ì›í•˜ëŠ” í´ë” í•˜ë‚˜ ì„ íƒí•´ì„œ ì‹¤í–‰
target_folder = "f_ëŒ€íŒŒ"  # <-- ì—¬ê¸°ì— ì‹¤í–‰í•  í´ë”ëª… ì…ë ¥!
image_folder = os.path.join(base_folder, target_folder)
filtered_folder = os.path.join(filtered_base_folder, target_folder)
os.makedirs(filtered_folder, exist_ok=True)

# ğŸ“Œ í•´ë‹¹ í´ë”ì— ë§ëŠ” text_inputs ì ìš©
text_inputs = folder_text_inputs.get(target_folder, ["This is a fresh ingredient from the kitchen", "This is a cooked dish", "This is an unrelated image"])
print(f"\nğŸ” {target_folder} í´ë”ë¥¼ í•„í„°ë§ ì¤‘... (ê¸°ì¤€: {text_inputs})")

# ì´ë¯¸ì§€ í•„í„°ë§ ì‹¤í–‰
for image_name in os.listdir(image_folder):
    image_path = os.path.join(image_folder, image_name)

    try:
        image = Image.open(image_path)
        inputs = processor(text=text_inputs, images=image, return_tensors="pt", padding=True)
        outputs = model(**inputs)

        probs = torch.softmax(outputs.logits_per_image, dim=1).tolist()[0]

        if probs[0] > max(probs[1], probs[2]):
            image.save(os.path.join(filtered_folder, image_name))
            print(f"âœ… ìƒí’ˆ ì´ë¯¸ì§€ë¡œ ë¶„ë¥˜ë¨: {image_name}")
        else:
            os.remove(image_path)  # âŒ í•„í„°ë§ëœ ì´ë¯¸ì§€ ì‚­ì œ
            print(f"âŒ ì œê±°ë¨: {image_name} (ì¡°ë¦¬ëœ ìŒì‹ ë˜ëŠ” ë¬´ê´€í•œ ì´ë¯¸ì§€)")

    except Exception as e:
        os.remove(image_path)  # âš ï¸ ì˜¤ë¥˜ ë°œìƒí•œ ì´ë¯¸ì§€ ì‚­ì œ
        print(f"âš ï¸ ì˜¤ë¥˜ ë°œìƒ ë° ì‚­ì œë¨: {image_name} - {str(e)}")

print(f"\nğŸ¯ {target_folder} í•„í„°ë§ ì™„ë£Œ! âœ…")
